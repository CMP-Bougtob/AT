<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <title>نظام تسجيل الدخول والخروج - اتصالات الجزائر</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ... (نفس الأنماط السابقة) ... */
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <img src="./images/logo.png" alt="شعار اتصالات الجزائر" class="logo">
            <h1>نظام تسجيل الدخول والخروج - خلية الصيانة والإنتاج</h1>
        </header>

        <div class="controls">
            <button class="btn btn-login" onclick="startAttendance('in')" id="loginBtn">
                تسجيل الدخول
            </button>
            <button class="btn btn-logout" onclick="startAttendance('out')" id="logoutBtn">
                تسجيل الخروج
            </button>
            <button class="btn btn-holiday" onclick="startHolidayProcess()" id="holidayBtn">
                تعيين عطلة
            </button>
        </div>

        <div id="loading" class="loading">جاري التحميل...</div>
        <div id="error" class="error"></div>
        <div id="countdown" class="countdown">3</div>

        <div class="video-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>

        <div class="table-container">
            <table id="attendanceTable">
                <thead>
                    <tr>
                        <th>اسم الموظف</th>
                        <th>الفترة الصباحية</th>
                        <th>الفترة المسائية</th>
                        <th>الحالة</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <button class="btn" onclick="exportToExcel()" id="exportBtn" style="background-color: var(--primary-color); color: white; margin: 0 auto; display: block;">
            استخراج التقرير
        </button>
    </div>

    <!-- نافذة منبثقة لتحديد مدة العطلة -->
    <div id="holidayModal" class="modal">
        <h3>تعيين عطلة</h3>
        <p id="holidayEmployeeName"></p>
        <label for="startDate">من تاريخ:</label>
        <input type="date" id="startDate" required>
        <label for="endDate">إلى تاريخ:</label>
        <input type="date" id="endDate" required>
        <button class="confirm" onclick="confirmHoliday()">تأكيد</button>
        <button class="cancel" onclick="closeHolidayModal()">إلغاء</button>
    </div>
    <div id="holidayModalOverlay" class="modal-overlay"></div>

    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // بيانات الموظفين
        let employees = [];

        // متغيرات عامة
        let isInitialized = false;
        let isProcessing = false;
        let currentStream = null;
        let labeledFaceDescriptors = null;
        let faceMatcher = null;
        let selectedEmployeeForHoliday = null; // الموظف المحدد للعطلة

        // API URL
        const API_URL = 'https://cmp-bougtob.42web.io/api.php';

        // جلب بيانات الموظفين من قاعدة البيانات
        async function fetchEmployees() {
            try {
                const response = await fetch(`${API_URL}?action=getEmployees`);
                const data = await response.json();
                if (data.success) {
                    employees = data.employees;
                    updateAttendanceTable();
                } else {
                    throw new Error('فشل في جلب بيانات الموظفين');
                }
            } catch (error) {
                console.error("فشل في جلب بيانات الموظفين:", error);
                showError('فشل في جلب بيانات الموظفين: ' + error.message);
            }
        }

        // حفظ بيانات الموظفين في قاعدة البيانات
        async function saveEmployees() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveEmployees',
                        employees: employees,
                    }),
                });
                const data = await response.json();
                if (!data.success) {
                    throw new Error('فشل في حفظ بيانات الموظفين');
                }
            } catch (error) {
                console.error("فشل في حفظ بيانات الموظفين:", error);
                showError('فشل في حفظ بيانات الموظفين: ' + error.message);
            }
        }

        // فتح نافذة العطلة
        function openHolidayModal(employee) {
            selectedEmployeeForHoliday = employee;
            document.getElementById('holidayEmployeeName').textContent = `تعيين عطلة لـ: ${employee.name}`;
            document.getElementById('holidayModal').style.display = 'block';
            document.getElementById('holidayModalOverlay').style.display = 'block';
        }

        // إغلاق نافذة العطلة
        function closeHolidayModal() {
            document.getElementById('holidayModal').style.display = 'none';
            document.getElementById('holidayModalOverlay').style.display = 'none';
            selectedEmployeeForHoliday = null;
        }

        // تأكيد العطلة
        async function confirmHoliday() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                alert("الرجاء تحديد تاريخي بداية ونهاية العطلة.");
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert("تاريخ البداية يجب أن يكون قبل تاريخ النهاية.");
                return;
            }

            selectedEmployeeForHoliday.holiday = { start: startDate, end: endDate };
            selectedEmployeeForHoliday.status = "holiday";
            updateAttendanceTable();
            closeHolidayModal();
            await saveEmployees(); // حفظ التغييرات في قاعدة البيانات
            alert(`تم تعيين عطلة لـ ${selectedEmployeeForHoliday.name} من ${startDate} إلى ${endDate}`);
        }

        // ... (بقية الوظائف بدون تغيير) ...

        // تحديث جدول الحضور
        function updateAttendanceTable() {
            const tbody = document.querySelector('#attendanceTable tbody');
            tbody.innerHTML = employees.map(emp => `
                <tr>
                    <td>${emp.name}</td>
                    <td dir="ltr">${formatPeriod(emp.morning)}</td>
                    <td dir="ltr">${formatPeriod(emp.evening)}</td>
                    <td class="status-${emp.status}">
                        <strong>${emp.status === 'in' ? 'متواجد' : emp.status === 'out' ? 'غير متواجد' : 'عطلة'}</strong>
                    </td>
                </tr>
            `).join('');
        }

        // ... (بقية الوظائف بدون تغيير) ...

        // مستمعات الأحداث
        window.addEventListener('load', async () => {
            await fetchEmployees(); // جلب بيانات الموظفين من قاعدة البيانات
            await initializeSystem();
        });

        window.addEventListener('beforeunload', async () => {
            await saveEmployees(); // حفظ البيانات في قاعدة البيانات قبل إغلاق الصفحة
        });

        // الحفظ التلقائي الدوري
        setInterval(async () => {
            await saveEmployees(); // حفظ البيانات كل دقيقة
        }, 60000);
    </script>
</body>
</html>
